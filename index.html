<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Home Shopping Tracker</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans select-none">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo } = React;
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, addDoc, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAMHGLSbvAbvxAhyCNUlG6X44f1ZoiFAuQ",
            authDomain: "home-shopping-tracker.firebaseapp.com",
            projectId: "home-shopping-tracker",
            storageBucket: "home-shopping-tracker.firebasestorage.app",
            messagingSenderId: "551174056725",
            appId: "1:551174056725:web:d305f58bc347353bb4171c",
            measurementId: "G-DJYR68JH7E"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "home-shopping-shared-v1";

        // --- Icons ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                home: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
                plus: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>,
                star: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
                settings: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
                trash: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
                link: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>,
                trending: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
                loader: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg>,
                alert: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
                info: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
                refresh: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>,
                key: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
            };
            return <div className={className}>{icons[name]}</div>;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [authError, setAuthError] = useState(null);
            const [permError, setPermError] = useState(false);
            const [properties, setProperties] = useState([]);
            const [needs, setNeeds] = useState({ maxPrice: 550000, maxHOA: 500 });
            const [view, setView] = useState('list');
            const [selectedId, setSelectedId] = useState(null);
            const [newUrl, setNewUrl] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [loading, setLoading] = useState(true);
            const [deletingId, setDeletingId] = useState(null);
            const [statusMsg, setStatusMsg] = useState(null);
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_key') || '');

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            try { await signInWithCustomToken(auth, token); } 
                            catch { await signInAnonymously(auth); }
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        setAuthError(err.code === 'auth/configuration-not-found' ? "Enable Anonymous Sign-in in Firebase Console" : err.message);
                        setLoading(false);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => { if (u) { setUser(u); setLoading(false); } });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsub1 = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'properties')), s => setProperties(s.docs.map(d => ({id: d.id, ...d.data()}))), e => { if(e.code === 'permission-denied') setPermError(true); });
                const unsub2 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'shared_needs'), s => { if(s.exists()) setNeeds(s.data()) }, e => { if(e.code === 'permission-denied') setPermError(true); });
                return () => { unsub1(); unsub2(); };
            }, [user]);

            // --- CRITICAL FIX: Safe Data Sanitizer ---
            // Firestore crashes if values are undefined. This forces them to null or defaults.
            const sanitizeData = (data) => {
                const clean = {};
                // Default fallback image
                const fallbackImage = "https://images.unsplash.com/photo-1560518883-ce09059eeffa?auto=format&fit=crop&w=800&q=80";
                
                clean.address = data.address || "Address Pending";
                clean.city = data.city || "Unknown City";
                clean.price = typeof data.price === 'number' ? data.price : 0;
                clean.hoa = typeof data.hoa === 'number' ? data.hoa : 0;
                clean.commuteTime = typeof data.commuteTime === 'number' ? data.commuteTime : 0;
                clean.summary = data.summary || "Summary pending sync.";
                clean.expertTake = data.expertTake || "Analysis pending.";
                clean.image = (data.image && data.image.startsWith('http')) ? data.image : fallbackImage;
                clean.url = data.url || "";
                clean.status = data.status || "interested";
                clean.userFeedback = data.userFeedback || "";
                
                // Remove any accidental undefined keys
                return JSON.parse(JSON.stringify(clean)); 
            };

            const smartExtract = async (url) => {
                try {
                    // Layer 1: Microlink
                    const apiUrl = `https://api.microlink.io/?url=${encodeURIComponent(url)}&palette=true`;
                    const res = await fetch(apiUrl);
                    const json = await res.json();
                    
                    if (json.status === 'success') {
                        const { title, description, image, url: finalUrl } = json.data;
                        
                        // Regex to find price in text (e.g. "$450,000")
                        const priceMatch = (description + " " + title).match(/\$([0-9]{1,3}(,[0-9]{3})*)/);
                        const price = priceMatch ? parseInt(priceMatch[1].replace(/,/g, '')) : 0;

                        // Basic Address Parse from Title
                        // Redfin Title: "123 Main St, City, ST..."
                        let address = "New Entry";
                        let city = "Unknown";
                        
                        if (title && title.includes(',')) {
                            const parts = title.split(',');
                            address = parts[0].trim().toUpperCase();
                            if (parts[1]) city = parts[1].trim().toUpperCase();
                        }

                        // Zillow Specific URL Parse fallback
                        if (address === "New Entry" && url.includes('zillow.com')) {
                            try {
                                const path = new URL(url).pathname;
                                const addrPart = path.split('/').find(p => p.includes('-IL-')); // e.g. 123-Main-St-City-IL-12345
                                if (addrPart) {
                                    const raw = addrPart.split('-IL-')[0];
                                    address = raw.replace(/-/g, ' ').toUpperCase();
                                }
                            } catch(e) {}
                        }

                        return {
                            address, city, price, 
                            image: image?.url, 
                            summary: description ? description.substring(0, 160) + "..." : "",
                            url: finalUrl || url
                        };
                    }
                } catch (e) {
                    console.warn("Extraction layer 1 failed", e);
                }
                
                // Fallback: Safe defaults if extraction completely fails
                return {
                    address: "Check Link for Address",
                    city: "Unknown",
                    price: 0,
                    summary: "Could not auto-extract. Tap to edit details manually.",
                    image: null // Sanitizer will fix this
                };
            };

            // --- AI Enhance (Optional) ---
            const enhanceWithAI = async (baseData) => {
                if (!apiKey) return {};
                try {
                    const prompt = `Analyze: ${JSON.stringify(baseData)}. 
                    Return JSON: { "hoa": number, "commuteTime": number (mins to Waukegan IL), "expertTake": "Short analysis" }`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                    });
                    const json = await res.json();
                    return JSON.parse(json.candidates[0].content.parts[0].text);
                } catch (e) { return {}; }
            };

            const addProperty = async () => {
                if (!newUrl || !user) return;
                setIsProcessing(true);
                setStatusMsg("Scanning...");
                try {
                    const extracted = await smartExtract(newUrl);
                    let aiData = {};
                    if (apiKey) {
                        setStatusMsg("AI Analyzing...");
                        aiData = await enhanceWithAI(extracted);
                    }
                    
                    // CRITICAL: Sanitize before save
                    const finalData = sanitizeData({ 
                        ...extracted, 
                        ...aiData, 
                        url: newUrl,
                        addedAt: new Date().toISOString()
                    });

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'properties'), finalData);
                    setNewUrl('');
                    setView('list');
                } catch (e) {
                    setStatusMsg("Error: " + e.message);
                } finally { setIsProcessing(false); }
            };

            const handleReSync = async (propId, url, currentData) => {
                setIsProcessing(true);
                try {
                    const extracted = await smartExtract(url);
                    let aiData = {};
                    if (apiKey) aiData = await enhanceWithAI(extracted);
                    
                    // Merge Strategy: Don't overwrite valid manual data with 0/empty
                    const merged = { ...extracted, ...aiData };
                    if (merged.price === 0 && currentData.price > 0) merged.price = currentData.price;
                    if (merged.hoa === 0 && currentData.hoa > 0) merged.hoa = currentData.hoa;
                    if (merged.commuteTime === 0 && currentData.commuteTime > 0) merged.commuteTime = currentData.commuteTime;

                    const finalData = sanitizeData(merged);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', propId), finalData);
                } catch (e) {
                    alert("Sync failed: " + e.message);
                } finally { setIsProcessing(false); }
            };

            const calculateScore = (p) => {
                let s = 0;
                if(p.price > 0 && p.price <= needs.maxPrice) s+=25;
                if(p.hoa > 0 && p.hoa <= needs.maxHOA) s+=25;
                if(p.commuteTime > 0 && p.commuteTime <= 30) s+=25;
                else if(p.commuteTime === 0) s+=10;
                if(p.image && !p.image.includes('unsplash')) s+=25;
                return s;
            };

            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('gemini_key', key);
            };

            if (permError) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center bg-slate-50">
                    <Icon name="alert" size={64} className="text-amber-500 mb-6" />
                    <h1 className="text-2xl font-black mb-4 text-slate-800">Database Rules Locked</h1>
                    <p className="text-sm text-slate-500 mb-8 max-w-xs">Go to Firebase Console &gt; Firestore &gt; Rules and allow read/write access.</p>
                    <button onClick={() => window.location.reload()} className="px-8 py-3 bg-blue-600 text-white rounded-full font-bold shadow-lg">Retry</button>
                </div>
            );

            if (loading) return <div className="min-h-screen flex items-center justify-center"><Icon name="loader" className="animate-spin text-blue-600" size={40}/></div>;

            const activeProp = selectedId ? properties.find(p => p.id === selectedId) : null;

            return (
                <div className="min-h-screen pb-24 max-w-md mx-auto bg-slate-50 shadow-2xl flex flex-col border-x border-slate-200">
                    {/* Headers & Nav */}
                    <header className="bg-white/80 backdrop-blur-md border-b sticky top-0 z-10 p-4 flex justify-between items-center safe-top">
                        <h1 className="text-xl font-black text-slate-800 flex items-center gap-2"><Icon name="home" className="text-blue-600"/> {view === 'list' ? 'Tracker' : 'Details'}</h1>
                        {view === 'list' ? 
                            <button onClick={() => setView('add')} className="p-2 bg-blue-600 text-white rounded-full shadow-md"><Icon name="plus" size={20}/></button> : 
                            <button onClick={() => setView('list')} className="text-slate-500 font-bold text-xs uppercase">Back</button>
                        }
                    </header>

                    <main className="p-4 flex-1">
                        {view === 'list' && (
                            <div>
                                {properties.map(p => (
                                    <div key={p.id} onClick={() => { setSelectedId(p.id); setView('detail'); }} className="bg-white rounded-2xl border mb-4 shadow-sm overflow-hidden active:scale-95 transition-transform">
                                        <div className="h-40 bg-slate-200 relative">
                                            <img src={p.image} className="w-full h-full object-cover" onError={(e) => e.target.src="https://images.unsplash.com/photo-1560518883-ce09059eeffa?auto=format&fit=crop&w=800&q=80"}/>
                                            {p.price > 0 && <div className="absolute bottom-2 right-2 bg-blue-600 text-white text-xs font-black px-2 py-1 rounded shadow">${(p.price/1000).toFixed(0)}k</div>}
                                        </div>
                                        <div className="p-4">
                                            <h3 className="font-black text-lg truncate uppercase">{p.address}</h3>
                                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">{p.city}</p>
                                            <div className="flex gap-2">
                                                <span className="bg-blue-50 text-blue-600 text-[10px] font-black px-2 py-1 rounded uppercase">{calculateScore(p)}% Match</span>
                                                {p.hoa > 0 && <span className="bg-slate-100 text-slate-500 text-[10px] font-black px-2 py-1 rounded uppercase">${p.hoa} HOA</span>}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'detail' && activeProp && (
                            <div className="animate-in slide-in-from-right duration-300 pb-10">
                                <div className="h-64 bg-slate-200 rounded-3xl overflow-hidden mb-6 relative shadow-lg">
                                    <img src={activeProp.image} className="w-full h-full object-cover" onError={(e) => e.target.src="https://images.unsplash.com/photo-1560518883-ce09059eeffa?auto=format&fit=crop&w=800&q=80"}/>
                                    <a href={activeProp.url} target="_blank" className="absolute top-4 right-4 p-3 bg-white/90 rounded-full text-blue-600 shadow"><Icon name="link" size={20}/></a>
                                </div>
                                
                                <div className="flex justify-between items-start mb-6">
                                    <div className="flex-1 pr-4">
                                        <input className="text-2xl font-black uppercase w-full bg-transparent outline-none border-b border-transparent focus:border-blue-500" value={activeProp.address} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', selectedId), {address: e.target.value.toUpperCase()})} />
                                        <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mt-1">{activeProp.city}</p>
                                    </div>
                                    <div className="text-right">
                                        <input type="number" className="text-2xl font-black text-right w-32 bg-transparent outline-none text-blue-600 border-b border-transparent focus:border-blue-500" value={activeProp.price} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', selectedId), {price: parseInt(e.target.value) || 0})} />
                                        <p className="text-[10px] font-black text-slate-400 uppercase">Price</p>
                                    </div>
                                </div>

                                <div className="bg-white p-5 rounded-2xl border border-slate-100 mb-6 shadow-sm">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold flex items-center gap-2 text-xs uppercase text-slate-400 tracking-widest font-black"><Icon name="info" size={14}/> Summary</h3>
                                        <button onClick={() => handleReSync(selectedId, activeProp.url, activeProp)} disabled={isProcessing} className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-full text-[10px] font-black uppercase tracking-widest active:scale-90 transition-all disabled:opacity-50">
                                            {isProcessing ? <Icon name="loader" size={10} className="animate-spin"/> : <Icon name="refresh" size={10}/>} Re-Sync
                                        </button>
                                    </div>
                                    <p className="text-sm text-slate-600 leading-relaxed font-medium">{activeProp.summary}</p>
                                </div>

                                <div className="grid grid-cols-2 gap-3 mb-6">
                                    <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">HOA</p>
                                        <input type="number" className="text-xl font-black text-center w-full outline-none" value={activeProp.hoa} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', selectedId), {hoa: parseInt(e.target.value)})} />
                                    </div>
                                    <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Commute</p>
                                        <div className="text-xl font-black text-slate-800">{activeProp.commuteTime > 0 ? activeProp.commuteTime + "m" : "?"}</div>
                                    </div>
                                </div>

                                <textarea className="w-full h-32 p-4 bg-white border rounded-xl text-sm mb-6" placeholder="My notes..." value={activeProp.userFeedback} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', selectedId), {userFeedback: e.target.value})} />
                                <button onClick={async () => { if(confirm('Delete?')) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', selectedId)); setView('list'); }}} className="w-full py-4 text-rose-500 font-black text-xs uppercase">Delete Entry</button>
                            </div>
                        )}

                        {view === 'add' && (
                            <div className="bg-white p-6 rounded-3xl border shadow-xl">
                                <h2 className="text-xl font-black mb-4">Add Link</h2>
                                <input className="w-full p-4 bg-slate-50 border rounded-xl mb-4 text-sm" placeholder="Paste Redfin/Zillow Link..." value={newUrl} onChange={e => setNewUrl(e.target.value)} />
                                {statusMsg && <div className="text-xs text-blue-600 font-bold mb-4 flex items-center gap-2"><Icon name="loader" className="animate-spin" size={12}/> {statusMsg}</div>}
                                <button onClick={addProperty} disabled={isProcessing} className="w-full py-4 bg-blue-600 text-white font-black rounded-xl uppercase tracking-widest shadow-lg disabled:opacity-50">
                                    {isProcessing ? 'Processing...' : 'Extract Data'}
                                </button>
                                {!apiKey && <p className="text-[10px] text-slate-400 mt-4 text-center">Add AI Key in Settings for HOA/Commute data.</p>}
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="space-y-6">
                                <h2 className="text-xl font-black">Settings</h2>
                                <div className="bg-white p-5 rounded-2xl border shadow-sm">
                                    <label className="text-xs font-black text-blue-600 uppercase block mb-2"><Icon name="key"/> AI Power-Up (Free)</label>
                                    <p className="text-[10px] text-slate-500 mb-4">Get key at <a href="https://aistudio.google.com/app/apikey" target="_blank" className="underline">Google AI Studio</a></p>
                                    <input className="w-full p-3 bg-slate-50 border rounded-xl text-xs font-mono" placeholder="Paste Gemini Key..." value={apiKey} onChange={e => saveApiKey(e.target.value)} />
                                </div>
                                <div className="bg-white p-5 rounded-2xl border shadow-sm">
                                    <label className="text-[10px] font-black text-slate-400 uppercase block mb-2">Max Budget</label>
                                    <input type="number" className="text-xl font-black w-full outline-none" value={needs.maxPrice} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'shared_needs'), {maxPrice: parseInt(e.target.value)})} />
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-4">
                        <button onClick={() => setView('list')} className={`flex flex-col items-center ${view === 'list' ? 'text-blue-600' : 'text-slate-400'}`}><Icon name="home"/><span className="text-[9px] font-black uppercase mt-1">List</span></button>
                        <button onClick={() => setView('settings')} className={`flex flex-col items-center ${view === 'settings' ? 'text-blue-600' : 'text-slate-400'}`}><Icon name="settings"/><span className="text-[9px] font-black uppercase mt-1">Goals</span></button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
