<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Home Shopping Tracker</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans select-none">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo } = React;
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, addDoc, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAMHGLSbvAbvxAhyCNUlG6X44f1ZoiFAuQ",
            authDomain: "home-shopping-tracker.firebaseapp.com",
            projectId: "home-shopping-tracker",
            storageBucket: "home-shopping-tracker.firebasestorage.app",
            messagingSenderId: "551174056725",
            appId: "1:551174056725:web:d305f58bc347353bb4171c",
            measurementId: "G-DJYR68JH7E"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "home-shopping-shared-v1";

        // --- Icons ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                home: <><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
                plus: <><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>,
                star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>,
                settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
                trash: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                link: <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></>,
                trending: <><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></>,
                car: <><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></>,
                loader: <><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></>,
                alert: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
                info: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>,
                refresh: <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>,
                key: <><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [properties, setProperties] = useState([]);
            const [needs, setNeeds] = useState({ maxPrice: 550000, maxHOA: 500 });
            const [view, setView] = useState('list');
            const [selectedId, setSelectedId] = useState(null);
            const [newUrl, setNewUrl] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [loading, setLoading] = useState(true);
            const [deletingId, setDeletingId] = useState(null);
            const [statusMsg, setStatusMsg] = useState(null);
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_key') || '');

            useEffect(() => {
                signInAnonymously(auth).catch(e => console.error(e));
                return onAuthStateChanged(auth, u => { if(u) { setUser(u); setLoading(false); }});
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsub1 = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'properties')), s => 
                    setProperties(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub2 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'shared_needs'), s => 
                    s.exists() && setNeeds(s.data()));
                return () => { unsub1(); unsub2(); };
            }, [user]);

            // --- Utility: Clean Data for Firestore (Prevents Undefined Errors) ---
            const sanitizeData = (data) => {
                const clean = {};
                Object.keys(data).forEach(key => {
                    if (data[key] === undefined) clean[key] = null;
                    else clean[key] = data[key];
                });
                return clean;
            };

            // --- Real Extraction Logic (No Simulation) ---
            // Uses a CORS proxy to fetch raw HTML and parse OpenGraph tags
            const fetchOpenGraphData = async (url) => {
                try {
                    // Using allorigins.win as a CORS proxy
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    const json = await response.json();
                    
                    if (!json.contents) throw new Error("No content received");
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(json.contents, "text/html");
                    
                    // Safe Accessors
                    const getMeta = (prop) => doc.querySelector(`meta[property="${prop}"]`)?.content || "";
                    
                    const ogTitle = getMeta("og:title");
                    const ogImage = getMeta("og:image");
                    const ogDesc = getMeta("og:description");

                    // Fallback to title tag if og:title missing
                    const title = ogTitle || doc.title || "Unknown Property";

                    // Parsing Logic for Redfin/Zillow
                    // Example Redfin Title: "123 Main St, City, ST 12345 | MLS#..."
                    // Example Redfin Desc: "3 beds, 2 baths... | $455,000"
                    
                    let price = 0;
                    const priceMatch = (ogDesc + title).match(/\$[\d,]+/);
                    if (priceMatch) {
                        price = parseInt(priceMatch[0].replace(/[$,]/g, ''));
                    }

                    // Extract Address/City
                    let address = "Address Pending";
                    let city = "";
                    
                    // Try to parse from Title first
                    const parts = title.split(',');
                    if (parts.length >= 2) {
                        address = parts[0].trim();
                        city = parts[1].trim();
                    } else {
                        // Fallback to URL parsing if title fails
                        try {
                            const urlObj = new URL(url);
                            const pathParts = urlObj.pathname.split('/');
                            // Typical Redfin pattern: /state/city/address/home/...
                            const stateIdx = pathParts.indexOf('IL'); // Heuristic
                            if (stateIdx !== -1 && pathParts[stateIdx + 2]) {
                                address = pathParts[stateIdx + 2].replace(/-/g, ' ');
                                city = pathParts[stateIdx + 1].replace(/-/g, ' ');
                            }
                        } catch (e) {
                            console.warn("URL parse fail", e);
                        }
                    }

                    // Validated Image URL or Placeholder
                    const finalImage = (ogImage && ogImage.startsWith('http')) 
                        ? ogImage 
                        : "https://images.unsplash.com/photo-1560518883-ce09059eeffa?auto=format&fit=crop&w=800&q=80";

                    return {
                        address: address.toUpperCase(),
                        city: city.toUpperCase(),
                        price: price,
                        image: finalImage,
                        summary: ogDesc.substring(0, 160) + "...",
                        hoa: 0, // Defaults to 0, requires manual or AI check
                        commuteTime: 0 // Defaults to 0
                    };

                } catch (e) {
                    console.warn("Proxy Scraping Failed:", e);
                    // Minimal fallback to prevent crash
                    return {
                        address: "New Entry (Sync Failed)",
                        city: "Unknown",
                        price: 0,
                        image: "https://images.unsplash.com/photo-1560518883-ce09059eeffa?auto=format&fit=crop&w=800&q=80",
                        summary: "Could not auto-extract data. Please enter details manually.",
                        hoa: 0,
                        commuteTime: 0
                    };
                }
            };

            // --- AI Extractor (Optional) ---
            const enhanceWithAI = async (url, baseData) => {
                if (!apiKey) return {};
                try {
                    const prompt = `Analyze this real estate listing: ${url}. 
                    Extract HOA fees and calculate commute to 1675 S Lakeside Dr, Waukegan IL.
                    Context: ${JSON.stringify(baseData)}.
                    Return JSON: { "hoa": number, "commuteTime": number (minutes), "expertTake": "Short analysis" }`;
                    
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            tools: [{ "google_search": {} }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const json = await res.json();
                    return JSON.parse(json.candidates[0].content.parts[0].text);
                } catch (e) {
                    console.error("AI Enhance Failed", e);
                    return {};
                }
            };

            const handleAdd = async () => {
                if (!newUrl) return;
                setIsProcessing(true);
                setStatusMsg("Connecting to listing...");
                
                try {
                    // 1. Scraping Layer
                    const extracted = await fetchOpenGraphData(newUrl);
                    
                    // 2. AI Layer (if key exists)
                    let aiData = {};
                    if (apiKey) {
                        setStatusMsg("AI analyzing...");
                        aiData = await enhanceWithAI(newUrl, extracted);
                    }

                    // 3. Save (Sanitized)
                    const payload = sanitizeData({
                        ...extracted,
                        ...aiData,
                        url: newUrl,
                        status: 'interested',
                        userFeedback: '',
                        addedAt: new Date().toISOString()
                    });

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'properties'), payload);
                    setNewUrl('');
                    setView('list');
                } catch (e) {
                    setStatusMsg("Error: " + e.message);
                } finally { setIsProcessing(false); }
            };

            const handleReSync = async (propId, url) => {
                setIsProcessing(true);
                try {
                    const extracted = await fetchOpenGraphData(url);
                    let aiData = {};
                    if (apiKey) aiData = await enhanceWithAI(url, extracted);
                    
                    const payload = sanitizeData({ ...extracted, ...aiData });
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', propId), payload);
                } catch (e) {
                    alert("Sync Error: " + e.message);
                } finally { setIsProcessing(false); }
            };

            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('gemini_key', key);
            };

            const calculateScore = (p) => {
                let s = 0;
                if(p.price <= needs.maxPrice) s+=25;
                if(p.hoa <= needs.maxHOA) s+=25;
                if(p.commuteTime && p.commuteTime <= 30) s+=25;
                else if (!p.commuteTime) s+=10; 
                if(p.image && !p.image.includes('unsplash')) s+=25; // Bonus for real image
                return s;
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center"><Icon name="loader" className="animate-spin text-blue-600" size={40}/></div>;

            const activeProp = selectedId ? properties.find(p => p.id === selectedId) : null;

            return (
                <div className="min-h-screen pb-24 max-w-md mx-auto bg-slate-50 shadow-2xl flex flex-col border-x border-slate-200">
                    <header className="bg-white/80 backdrop-blur-md border-b sticky top-0 z-10 p-4 flex justify-between items-center">
                        <h1 className="text-xl font-black text-slate-800 flex items-center gap-2"><Icon name="home" className="text-blue-600"/> {view === 'list' ? 'Tracker' : 'Details'}</h1>
                        {view === 'list' ? 
                            <button onClick={() => setView('add')} className="p-2 bg-blue-600 text-white rounded-full shadow-md"><Icon name="plus"/></button> : 
                            <button onClick={() => setView('list')} className="text-slate-500 font-bold text-xs uppercase">Back</button>
                        }
                    </header>

                    <main className="p-4 flex-1">
                        {view === 'list' && (
                            <div>
                                {properties.map(p => (
                                    <div key={p.id} onClick={() => { setSelectedId(p.id); setView('detail'); }} className="bg-white rounded-2xl border mb-4 shadow-sm overflow-hidden active:scale-95 transition-transform">
                                        <div className="h-40 bg-slate-200 relative">
                                            <img src={p.image} className="w-full h-full object-cover" onError={(e) => e.target.src='https://images.unsplash.com/photo-1560518883-ce09059eeffa?auto=format&fit=crop&w=800&q=80'}/>
                                            <div className="absolute bottom-2 right-2 bg-blue-600 text-white text-xs font-black px-2 py-1 rounded shadow">${(p.price/1000).toFixed(0)}k</div>
                                        </div>
                                        <div className="p-4">
                                            <h3 className="font-black text-lg truncate uppercase">{p.address}</h3>
                                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">{p.city}</p>
                                            <div className="flex gap-2">
                                                <span className="bg-blue-50 text-blue-600 text-[10px] font-black px-2 py-1 rounded uppercase">{calculateScore(p)}% Match</span>
                                                {p.hoa > 0 && <span className="bg-slate-100 text-slate-500 text-[10px] font-black px-2 py-1 rounded uppercase">${p.hoa} HOA</span>}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'add' && (
                            <div className="bg-white p-6 rounded-3xl border shadow-xl">
                                <h2 className="text-xl font-black mb-4">Add Link</h2>
                                <input className="w-full p-4 bg-slate-50 border rounded-xl mb-4 text-sm" placeholder="Paste Redfin/Zillow Link..." value={newUrl} onChange={e => setNewUrl(e.target.value)} />
                                {statusMsg && <div className="text-xs text-blue-600 font-bold mb-4 flex items-center gap-2"><Icon name="loader" className="animate-spin" size={12}/> {statusMsg}</div>}
                                <button onClick={handleAdd} disabled={isProcessing} className="w-full py-4 bg-blue-600 text-white font-black rounded-xl uppercase tracking-widest shadow-lg disabled:opacity-50">
                                    {isProcessing ? 'Working...' : 'Extract Data'}
                                </button>
                                {!apiKey && <p className="text-[10px] text-slate-400 mt-4 text-center">Tip: Add API Key in Settings for deeper analysis.</p>}
                            </div>
                        )}

                        {view === 'detail' && activeProp && (
                            <div className="animate-in slide-in-from-right duration-300">
                                <div className="h-64 bg-slate-200 rounded-3xl overflow-hidden mb-6 relative shadow-lg">
                                    <img src={activeProp.image} className="w-full h-full object-cover" onError={(e) => e.target.src='https://images.unsplash.com/photo-1560518883-ce09059eeffa?auto=format&fit=crop&w=800&q=80'}/>
                                    <a href={activeProp.url} target="_blank" className="absolute top-4 right-4 p-3 bg-white/90 rounded-full text-blue-600 shadow"><Icon name="link"/></a>
                                </div>
                                
                                <div className="flex justify-between items-start mb-6">
                                    <div className="flex-1">
                                        <input className="text-2xl font-black uppercase w-full bg-transparent outline-none" value={activeProp.address} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', selectedId), {address: e.target.value})} />
                                        <p className="text-sm font-bold text-slate-400 uppercase tracking-widest">{activeProp.city}</p>
                                    </div>
                                    <div className="text-right">
                                        <input type="number" className="text-2xl font-black text-right w-32 bg-transparent outline-none text-blue-600" value={activeProp.price} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', selectedId), {price: parseInt(e.target.value)})} />
                                        <p className="text-[10px] font-black text-slate-400 uppercase">Price</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3 mb-6">
                                    <div className="bg-white p-4 rounded-xl border text-center">
                                        <p className="text-[10px] font-black text-slate-400 uppercase">HOA</p>
                                        <input type="number" className="text-xl font-black text-center w-full outline-none" value={activeProp.hoa || 0} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', selectedId), {hoa: parseInt(e.target.value)})} />
                                    </div>
                                    <div className="bg-white p-4 rounded-xl border text-center">
                                        <p className="text-[10px] font-black text-slate-400 uppercase">Commute</p>
                                        <div className="text-xl font-black">{activeProp.commuteTime || '?'}m</div>
                                    </div>
                                </div>

                                <div className="bg-white p-5 rounded-xl border mb-6">
                                    <button onClick={() => handleReSync(selectedId, activeProp.url)} className="w-full py-3 bg-blue-50 text-blue-600 font-black text-xs uppercase rounded-lg mb-4 flex items-center justify-center gap-2">
                                        {isProcessing ? <Icon name="loader" className="animate-spin"/> : <Icon name="refresh"/>} Re-Sync Listing
                                    </button>
                                    <p className="text-sm text-slate-600">{activeProp.summary}</p>
                                </div>

                                <div className="bg-slate-900 p-6 rounded-2xl text-white shadow-xl mb-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <p className="text-xs font-black text-blue-400 uppercase flex items-center gap-2"><Icon name="trending"/> AI Analysis</p>
                                        {activeProp.valuation && <p className="text-xs font-black">Est: ${activeProp.valuation.toLocaleString()}</p>}
                                    </div>
                                    <p className="text-sm opacity-80 italic">"{activeProp.expertTake || (apiKey ? "Tap Re-Sync to generate analysis." : "Add API Key in settings for analysis.")}"</p>
                                </div>

                                <textarea className="w-full h-32 p-4 bg-white border rounded-xl text-sm mb-6" placeholder="Notes..." value={activeProp.userFeedback} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', selectedId), {userFeedback: e.target.value})} />
                                
                                <button onClick={async () => { if(confirm('Delete?')) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', selectedId)); setView('list'); }}} className="w-full py-4 text-rose-500 font-black text-xs uppercase">Delete Entry</button>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="space-y-6">
                                <h2 className="text-xl font-black">App Settings</h2>
                                <div className="bg-white p-5 rounded-2xl border shadow-sm">
                                    <label className="text-xs font-black text-blue-600 uppercase block mb-2 flex items-center gap-2"><Icon name="key"/> AI Power-Up (Free)</label>
                                    <p className="text-[10px] text-slate-500 mb-4">Get a free key from <a href="https://aistudio.google.com/app/apikey" target="_blank" className="underline text-blue-500">Google AI Studio</a> to enable HOA detection and Expert Analysis.</p>
                                    <input className="w-full p-3 bg-slate-50 border rounded-xl text-xs font-mono" placeholder="Paste Gemini API Key here..." value={apiKey} onChange={e => saveApiKey(e.target.value)} />
                                </div>
                                <div className="bg-white p-5 rounded-2xl border shadow-sm">
                                    <label className="text-[10px] font-black text-slate-400 uppercase block mb-2">Max Budget</label>
                                    <input type="number" className="text-xl font-black w-full outline-none" value={needs.maxPrice} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'shared_needs'), {maxPrice: parseInt(e.target.value)})} />
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-4">
                        <button onClick={() => setView('list')} className={`flex flex-col items-center ${view === 'list' ? 'text-blue-600' : 'text-slate-400'}`}><Icon name="home"/><span className="text-[9px] font-black uppercase mt-1">List</span></button>
                        <button onClick={() => setView('settings')} className={`flex flex-col items-center ${view === 'settings' ? 'text-blue-600' : 'text-slate-400'}`}><Icon name="settings"/><span className="text-[9px] font-black uppercase mt-1">Goals</span></button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
